<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID Wastewater Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* Custom slider styles if needed */
        input[type=range] {
            appearance: none;  /* Hides the slider so that custom slider can be made */
            -webkit-appearance: none;
            width: 100%; /* Specific width is required for Firefox. */
            background: transparent; /* Otherwise white in Chrome */
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px; /* You need to specify a margin in Chrome, but in Firefox and IE it is automatic */
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d; /* Add cool effects to your sliders! */
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 1.3px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-900">
    <div class="container mx-auto px-4 py-4">
        <h1 class="text-3xl font-bold mb-2 text-center">National COVID Wastewater Forecast</h1>
        <p class="text-center mb-4 text-gray-600">
            Holt-Winters model (52-week seasonality) with 50% confidence intervals.
            Select a cut-off date to see the forecast vs actuals.
        </p>

        <div class="bg-white rounded-lg shadow-lg p-6 relative">
            <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
                <img src="loading.gif" alt="Loading..." class="w-16 h-16">
            </div>

            <div id="chart" class="w-full h-[600px] mb-2"></div>
            
            <div class="relative w-full">
                <!-- Slider Container that will be aligned -->
                <div id="slider-container" class="w-full">
                    <input type="range" id="dateSlider" min="0" max="100" value="100" class="w-full">
                </div>
                <div class="text-center mt-2">
                    <label for="dateSlider" class="font-semibold text-lg">Forecast Cut-off Date: <span id="cutoffDateLabel" class="text-blue-600"></span></label>
                </div>
                <p class="text-center mt-2 text-sm text-gray-500">Drag the slider to change the model training cut-off date. The upper 50% confidence interval region is bounded at an <a href="https://www.cdc.gov/nwss/data-methods.html#what">activity level</a> of 30.</p>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let dates = [];
        
        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                return data;
            } catch (e) {
                console.error("fetchData failed", e);
            }
        }

        async function fetchForecast(cutoffDate) {
            try {
                const response = await fetch('/api/forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cutoff_date: cutoffDate })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (e) {
                console.error("fetchForecast failed", e);
                throw e;
            }
        }

        function initChart(data) {
            if (!data) return;
            allData = data;
            dates = allData.map(d => d.date);
            
            // Set slider range
            const slider = document.getElementById('dateSlider');
            // Limit the earliest cutoff to 104 weeks (2 seasonal cycles) to avoid Holt-Winters errors
            const minIndex = 104;
            if (dates.length > minIndex) {
                slider.min = minIndex;
            } else {
                slider.min = 0;
            }
            slider.max = dates.length - 1;
            slider.value = dates.length - 1;
            
            updateChart(dates.length - 1); // Initial forecast at most recent date
            
            slider.addEventListener('input', (e) => {
                const index = parseInt(e.target.value);
                document.getElementById('cutoffDateLabel').innerText = dates[index];
            });

            slider.addEventListener('change', (e) => {
                const index = parseInt(e.target.value);
                updateChart(index);
            });

            // Handle resize
            window.addEventListener('resize', () => {
                const chart = document.getElementById('chart');
                Plotly.Plots.resize(chart).then(() => {
                    alignSlider();
                });
            });
        }

        function alignSlider() {
            const chart = document.getElementById('chart');
            if (!chart || !chart._fullLayout) {
                return;
            }
            
            const xaxis = chart._fullLayout.xaxis;
            const margin = chart._fullLayout.margin;
            
            if (dates.length === 0) return;

            const slider = document.getElementById('dateSlider');
            const minIndex = parseInt(slider.min) || 0;
            const maxIndex = parseInt(slider.max) || (dates.length - 1);

            const startDate = dates[minIndex];
            const endDate = dates[maxIndex];
            
            // Calculate pixels relative to the plot area
            let startPx = xaxis.c2p(startDate);
            let endPx = xaxis.c2p(endDate);
            
            // Fallback to timestamp if needed
            if (startPx === undefined || isNaN(startPx)) {
                 startPx = xaxis.c2p(new Date(startDate).getTime());
            }
            if (endPx === undefined || isNaN(endPx)) {
                 endPx = xaxis.c2p(new Date(endDate).getTime());
            }
            
            const leftOffset = margin.l + startPx;
            const width = endPx - startPx;
            
            const sliderContainer = document.getElementById('slider-container');
            
            // Apply styles
            sliderContainer.style.marginLeft = `${leftOffset}px`;
            sliderContainer.style.width = `${width}px`;
        }

        async function updateChart(cutoffIndex) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            const cutoffDate = dates[cutoffIndex];
            document.getElementById('cutoffDateLabel').innerText = cutoffDate;
            
            try {
                const forecastData = await fetchForecast(cutoffDate);

                const trainData = allData.slice(0, cutoffIndex + 1);
                const testData = allData.slice(cutoffIndex + 1); // Actual data after cutoff

                const trainDates = trainData.map(d => d.date);
                const trainValues = trainData.map(d => d.value);

                const testDates = testData.map(d => d.date);
                const testValues = testData.map(d => d.value);

                const forecastDates = forecastData.forecast.map(d => d.date);
                const forecastValues = forecastData.forecast.map(d => d.forecast);
                const lowerBound = forecastData.forecast.map(d => d.lower);
                const upperBound = forecastData.forecast.map(d => d.upper);

                const traces = [
                    // Confidence Interval (Lower)
                    {
                        x: forecastDates,
                        y: lowerBound,
                        type: 'scatter',
                        mode: 'lines',
                        line: { width: 0 },
                        showlegend: false,
                        hoverinfo: 'skip'
                    },
                    // Confidence Interval (Upper)
                    {
                        x: forecastDates,
                        y: upperBound,
                        type: 'scatter',
                        mode: 'lines',
                        fill: 'tonexty',
                        fillcolor: 'rgba(37, 99, 235, 0.2)',
                        line: { width: 0 },
                        name: '50% Confidence Interval',
                        hoverinfo: 'skip'
                    },
                    // Forecast
                    {
                        x: forecastDates,
                        y: forecastValues,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Forecast',
                        line: { color: '#2563eb', width: 3 }
                    },
                    // Actual Future Data (if any)
                    {
                        x: testDates,
                        y: testValues,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Actual',
                        line: { color: '#1f2937', width: 2, dash: 'dot' }
                    },
                    // Training Data
                    {
                        x: trainDates,
                        y: trainValues,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'History',
                        line: { color: '#1f2937', width: 2 }
                    },
                ];

                const layout = {
                    yaxis: { title: 'Wastewater Viral Activity Level' },
                    hovermode: 'x',
                    showlegend: true,
                    legend: { orientation: 'h', y: 1.1 },
                    margin: { t: 0, b: 25, l: 40, r: 0 }
                };

                await Plotly.react('chart', traces, layout);
                alignSlider();

                // Also align on relayout (zoom/pan)
                document.getElementById('chart').on('plotly_relayout', function(){
                    alignSlider();
                });
            } catch (e) {
                console.error("Error in updateChart:", e);
            } finally {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        // Initialize
        fetchData().then(initChart);

    </script>
</body>
</html>